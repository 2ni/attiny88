/*
 * library to control ST7789
 *
 * BLK off & RST low -> 300uA consumption
 * RST init sequence needed or it won't show anything
 * if device resetted, init() needed to show last screen again
 *
 */
#include <util/delay.h>
#include <avr/pgmspace.h>
#include "st7789.h"
#include "spi.h"
#include "def.h"
#include "uart.h"

// char set
const uint8_t char_map[96][6] PROGMEM = {
{ 0x00, 0x00, 0x00, 0x00, 0x00 }, // space (32)
{ 0x00, 0x00, 0x5F, 0x00, 0x00 }, // !
{ 0x00, 0x07, 0x00, 0x07, 0x00 }, // "
{ 0x14, 0x7F, 0x14, 0x7F, 0x14 }, // #
{ 0x24, 0x2A, 0x7F, 0x2A, 0x12 }, // $
{ 0x23, 0x13, 0x08, 0x64, 0x62 }, // %
{ 0x36, 0x49, 0x56, 0x20, 0x50 }, // &
{ 0x00, 0x08, 0x07, 0x03, 0x00 }, // '
{ 0x00, 0x1C, 0x22, 0x41, 0x00 }, // (
{ 0x00, 0x41, 0x22, 0x1C, 0x00 }, // )
{ 0x2A, 0x1C, 0x7F, 0x1C, 0x2A }, // *
{ 0x08, 0x08, 0x3E, 0x08, 0x08 }, // +
{ 0x00, 0x80, 0x70, 0x30, 0x00 }, // ,
{ 0x08, 0x08, 0x08, 0x08, 0x08 }, // -
{ 0x00, 0x00, 0x60, 0x60, 0x00 }, // .
{ 0x20, 0x10, 0x08, 0x04, 0x02 }, // /
{ 0x3E, 0x51, 0x49, 0x45, 0x3E }, // 0
{ 0x00, 0x42, 0x7F, 0x40, 0x00 }, // 1
{ 0x72, 0x49, 0x49, 0x49, 0x46 }, // 2
{ 0x21, 0x41, 0x49, 0x4D, 0x33 }, // 3
{ 0x18, 0x14, 0x12, 0x7F, 0x10 }, // 4
{ 0x27, 0x45, 0x45, 0x45, 0x39 }, // 5
{ 0x3C, 0x4A, 0x49, 0x49, 0x31 }, // 6
{ 0x41, 0x21, 0x11, 0x09, 0x07 }, // 7
{ 0x36, 0x49, 0x49, 0x49, 0x36 }, // 8
{ 0x46, 0x49, 0x49, 0x29, 0x1E }, // 9
{ 0x00, 0x00, 0x14, 0x00, 0x00 }, // :
{ 0x00, 0x40, 0x34, 0x00, 0x00 }, // ;
{ 0x00, 0x08, 0x14, 0x22, 0x41 }, // <
{ 0x14, 0x14, 0x14, 0x14, 0x14 }, // =
{ 0x00, 0x41, 0x22, 0x14, 0x08 }, // >
{ 0x02, 0x01, 0x59, 0x09, 0x06 }, // ?
{ 0x3E, 0x41, 0x5D, 0x59, 0x4E }, // @
{ 0x7C, 0x12, 0x11, 0x12, 0x7C }, // A
{ 0x7F, 0x49, 0x49, 0x49, 0x36 }, // B
{ 0x3E, 0x41, 0x41, 0x41, 0x22 }, // C
{ 0x7F, 0x41, 0x41, 0x41, 0x3E }, // D
{ 0x7F, 0x49, 0x49, 0x49, 0x41 }, // E
{ 0x7F, 0x09, 0x09, 0x09, 0x01 }, // F
{ 0x3E, 0x41, 0x41, 0x51, 0x73 }, // G
{ 0x7F, 0x08, 0x08, 0x08, 0x7F }, // H
{ 0x00, 0x41, 0x7F, 0x41, 0x00 }, // I
{ 0x20, 0x40, 0x41, 0x3F, 0x01 }, // J
{ 0x7F, 0x08, 0x14, 0x22, 0x41 }, // K
{ 0x7F, 0x40, 0x40, 0x40, 0x40 }, // L
{ 0x7F, 0x02, 0x1C, 0x02, 0x7F }, // M
{ 0x7F, 0x04, 0x08, 0x10, 0x7F }, // N
{ 0x3E, 0x41, 0x41, 0x41, 0x3E }, // O
{ 0x7F, 0x09, 0x09, 0x09, 0x06 }, // P
{ 0x3E, 0x41, 0x51, 0x21, 0x5E }, // Q
{ 0x7F, 0x09, 0x19, 0x29, 0x46 }, // R
{ 0x26, 0x49, 0x49, 0x49, 0x32 }, // S
{ 0x03, 0x01, 0x7F, 0x01, 0x03 }, // T
{ 0x3F, 0x40, 0x40, 0x40, 0x3F }, // U
{ 0x1F, 0x20, 0x40, 0x20, 0x1F }, // V
{ 0x3F, 0x40, 0x38, 0x40, 0x3F }, // W
{ 0x63, 0x14, 0x08, 0x14, 0x63 }, // X
{ 0x03, 0x04, 0x78, 0x04, 0x03 }, // Y
{ 0x61, 0x59, 0x49, 0x4D, 0x43 }, // Z
{ 0x00, 0x7F, 0x41, 0x41, 0x41 }, // [
{ 0x02, 0x04, 0x08, 0x10, 0x20 }, // backslash
{ 0x00, 0x41, 0x41, 0x41, 0x7F }, // ]
{ 0x04, 0x02, 0x01, 0x02, 0x04 }, // ^
{ 0x40, 0x40, 0x40, 0x40, 0x40 }, // -
{ 0x00, 0x03, 0x07, 0x08, 0x00 }, // `
{ 0x20, 0x54, 0x54, 0x78, 0x40 }, // a
{ 0x7F, 0x28, 0x44, 0x44, 0x38 }, // b
{ 0x38, 0x44, 0x44, 0x44, 0x28 }, // c
{ 0x38, 0x44, 0x44, 0x28, 0x7F }, // d
{ 0x38, 0x54, 0x54, 0x54, 0x18 }, // e
{ 0x00, 0x08, 0x7E, 0x09, 0x02 }, // f
{ 0x18, 0xA4, 0xA4, 0x9C, 0x78 }, // g
{ 0x7F, 0x08, 0x04, 0x04, 0x78 }, // h
{ 0x00, 0x44, 0x7D, 0x40, 0x00 }, // i
{ 0x20, 0x40, 0x40, 0x3D, 0x00 }, // j
{ 0x7F, 0x10, 0x28, 0x44, 0x00 }, // k
{ 0x00, 0x41, 0x7F, 0x40, 0x00 }, // l
{ 0x7C, 0x04, 0x78, 0x04, 0x78 }, // m
{ 0x7C, 0x08, 0x04, 0x04, 0x78 }, // n
{ 0x38, 0x44, 0x44, 0x44, 0x38 }, // o
{ 0xFC, 0x18, 0x24, 0x24, 0x18 }, // p
{ 0x18, 0x24, 0x24, 0x18, 0xFC }, // q
{ 0x7C, 0x08, 0x04, 0x04, 0x08 }, // r
{ 0x48, 0x54, 0x54, 0x54, 0x24 }, // s
{ 0x04, 0x04, 0x3F, 0x44, 0x24 }, // t
{ 0x3C, 0x40, 0x40, 0x20, 0x7C }, // u
{ 0x1C, 0x20, 0x40, 0x20, 0x1C }, // v
{ 0x3C, 0x40, 0x30, 0x40, 0x3C }, // w
{ 0x44, 0x28, 0x10, 0x28, 0x44 }, // x
{ 0x4C, 0x90, 0x90, 0x90, 0x7C }, // y
{ 0x44, 0x64, 0x54, 0x4C, 0x44 }, // z
{ 0x00, 0x08, 0x36, 0x41, 0x00 }, // {
{ 0x00, 0x00, 0x77, 0x00, 0x00 }, // |
{ 0x00, 0x41, 0x36, 0x08, 0x00 }, // }
{ 0x00, 0x06, 0x09, 0x06, 0x00 },  // degree symbol = '~'
{ 0xFF, 0xFF, 0xFF, 0xFF, 0xFF }
};

void st7789_send_data(uint8_t data) {
  // DF("dat: 0x%02x", data);
  PORTD |= _BV(DC); // DC high
  spi_fast_shift(data);
}

void st7789_send_cmd(uint8_t cmd) {
  // DF("cmd: 0x%02x", cmd);
  PORTD &= ~_BV(DC); // DC low
  spi_fast_shift(cmd);
}

void st7789_send_multi_data(uint8_t* buf, uint8_t len) {
  PORTD |= _BV(DC); // DC high
  spi_transmit_sync(buf, len);
}

void st7789_set_addr_window(uint8_t x0, uint8_t y0, uint8_t x1, uint8_t y1) {
  st7789_send_cmd(ST7789_CASET); // column
  st7789_send_data(0);
  st7789_send_data(x0);
  st7789_send_data(0);
  st7789_send_data(x1);

  st7789_send_cmd(ST7789_RASET); // row
  st7789_send_data(0);
  st7789_send_data(y0);
  st7789_send_data(0);
  st7789_send_data(y1);

  st7789_send_cmd(ST7789_RAMWR); // write to RAM
}

/*
 * convert rgb color to uint16_t value
 */
uint16_t st7789_convert_color(uint8_t r, uint8_t g, uint8_t b) {
  return (r & 0xf8)<<8 | (g & 0xfc)<<3 | b>>3;
}

void st7789_init() {
  uint8_t invert=1, rotate=0;

  DDR_SPI |= _BV(RST); // define RST as output
  DDRD |= _BV(DC);     // define DC as output
  DDR_BLK |= _BV(BLK); // define BLK as output

  spi_init(3); // spi mode 3 for 240x240 lcd w/o CS

  // st7789 init sequence
  // rst process seems to be needed
  /*
  PORT_SPI |= _BV(RST); // high
  _delay_ms(50);
  PORT_SPI &= ~_BV(RST); // low
  _delay_ms(50);
  */
  PORT_SPI |= _BV(RST); // high
  _delay_ms(50);

  st7789_send_cmd(0x01);        // software reset
  _delay_ms(150);
  st7789_send_cmd(0x11);        // out of sleep mode
  // _delay_ms(500);            // doesn't seem to be needed
  st7789_send_cmd(0x3a);
  st7789_send_data(0x05);       // color mode 16bit
  st7789_send_cmd(0x20+invert); // invert
  st7789_send_cmd(0x36);
  st7789_send_data(rotate<<5);  // MADCTL
  st7789_send_cmd(0x29);        // display on
  // _delay_ms(100);            // doesn't seem to be needed
}

void st7789_on() {
  PORT_BLK |= _BV(BLK); // high
}

void st7789_off() {
  PORT_BLK &= ~_BV(BLK); // low
}

void st7789_sleep() {
  st7789_send_cmd(ST7789_SLPIN);
  st7789_off();
  _delay_ms(5);
}

void st7789_wakeup() {
  st7789_send_cmd(ST7789_SLPOUT);
  st7789_on();
  _delay_ms(120);
}

void st7789_draw_point(uint8_t x, uint8_t y, uint16_t color) {
  // swap coordinates for now
  uint8_t tmp = y;
  y = x;
  x = tmp;
  y = ST7789_TFTHEIGHT - y;
  x = ST7789_TFTWIDTH - x;

  st7789_send_cmd(ST7789_RASET);
  uint8_t buf_y[4] = { 0, y, 0, y };
  st7789_send_multi_data(buf_y, 4);

  st7789_send_cmd(ST7789_CASET);
  uint8_t buf_x[4] = { 0, x, 0, x };
  st7789_send_multi_data(buf_x, 4);

  st7789_send_cmd(ST7789_RAMWR);
  st7789_send_data(color >> 8);
  st7789_send_data(color & 0xff);
}

void st7789_fill_rect(uint8_t x, uint8_t y, uint8_t w, uint8_t h, uint16_t color) {
  // swap coordinates for now
  uint8_t tmp = y;
  y = x;
  x = tmp;
  y = ST7789_TFTHEIGHT - y - h;
  x = ST7789_TFTWIDTH - x - w;

  if ((x >= ST7789_TFTWIDTH) || (y >= ST7789_TFTHEIGHT)) return;

  if ((x + w - 1) >= ST7789_TFTWIDTH) w = ST7789_TFTWIDTH - x;
  if ((y + h - 1) >= ST7789_TFTHEIGHT) w = ST7789_TFTHEIGHT - y;

  st7789_set_addr_window(x, y, x+w-1, y+h-1);

  uint8_t hi = color >> 8, lo = color & 0xFF;

  PORTD |= _BV(DC); // DC high
  for (y=h; y>0; y--) {
    for (x=w; x>0; x--) {
      spi_fast_shift(hi);
      spi_fast_shift(lo);
    }
  }
}

void st7789_fill_screen(uint16_t color) {
  st7789_fill_rect(0, 0, ST7789_TFTWIDTH, ST7789_TFTHEIGHT, color);
}

/*
 * ASCII char at x, y with bottom left corner
 */
void st7789_char(char c, uint8_t x, uint8_t y, uint8_t scale, uint16_t fgcolor, uint16_t bgcolor) {
  // swap coordinates for now
  uint8_t tmp = y;
  y = x;
  x = tmp;
  y = ST7789_TFTHEIGHT - y - 5*scale;
  x = ST7789_TFTWIDTH - x - 8*scale;

  uint16_t colour;
  st7789_set_addr_window(x, y, x+8*scale-1, y+6*scale-1);
  PORTD |= _BV(DC); // DC high

  for (uint8_t xx=5; xx>0; xx--) {
    uint8_t bits = pgm_read_byte(&char_map[c-32][xx-1]);
    // DF("0x%02x", bits);
    for (uint8_t xr=0; xr<scale; xr++) {
      for (uint8_t yy=8; yy>0; yy--) {
        if (bits>>(7-(yy-1)) & 1) colour = fgcolor; else colour = bgcolor;
        for (uint8_t yr=0; yr<scale; yr++) {
          spi_fast_shift(colour >> 8);
          spi_fast_shift(colour & 0xFF);
        }
      }
    }
  }
}

/*
 * render array of char
 */
void st7789_text(char* text, uint8_t length, uint8_t x, uint8_t y, uint8_t scale, uint8_t space, uint16_t fgcolor, uint16_t bgcolor) {
  for (uint8_t i=0; i<length; i++) {
    st7789_char(text[i], x, y, scale, fgcolor, bgcolor);
    x += 5*scale+space; // might add spacing
  }
}
